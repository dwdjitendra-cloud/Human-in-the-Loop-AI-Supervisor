# Human-in-the-Loop AI Supervisor

AI receptionist that answers from a knowledge base, escalates unknowns to human supervisors, and learns approved answers back into the KB.

Live deployments
- Backend (Render): https://human-in-the-loop-ai-supervisor-0umh.onrender.com
- Frontend (Vercel): https://reception-ai-inky.vercel.app

Stack
- Backend: Node.js, Express, MongoDB (Mongoose)
- Frontend: React (Vite), Tailwind CSS
- Voice: OpenAI STT/TTS on server, browser STT/TTS fallback, LiveKit token endpoint

## Overview

The system acts as a production-ready AI receptionist for small businesses:
- Calls or chat questions go to an automated agent.
- Agent answers from the knowledge base (KB) and safe business defaults (hours, location, services, phone).
- Unknown questions are escalated as Help Requests for supervisors to resolve.
- When a supervisor adds an approved answer, it’s stored in the KB for future automation.

## Features

- Help Request lifecycle: Pending → Resolved (with answer) → Unresolved (by timeout)
- Supervisor dashboard (auth), knowledge base CRUD and search
- Agent flow: KB lookup → defaults → escalate; no fabricated answers
- Voice endpoints: TTS, STT→answer→TTS; browser STT/TTS fallback; LiveKit token route
- Webhook simulation endpoint for simple notifications
- CORS hardening, environment-driven config, clean logs

## System architecture

High-level flow:

```
Frontend (React/Vite)
   ├─ LiveVoice (browser STT/TTS fallback)
   ├─ Pages: Pending/Resolved, Knowledge Base, Login
   └─ Services → REST API (/api/*)

Backend (Express/MongoDB)
   ├─ Routes: help-requests, knowledge-base, supervisors, voice, livekit, webhook
   ├─ Services: aiAgent (KB + defaults + escalation), STT/TTS, timeout handler
   ├─ Controllers + Models (Mongoose)
   └─ Utils: logger, error handler, CORS

External
   ├─ OpenAI (STT/TTS)
   └─ LiveKit (signaling; token generated by backend)
```

## Project structure

```
Human-in-the-Loop AI Supervisor/
├─ backend/
│  ├─ package.json
│  └─ src/
│     ├─ server.js
│     ├─ config/db.js
│     ├─ controllers/
│     │  ├─ helpRequestController.js
│     │  ├─ knowledgeBaseController.js
│     │  └─ supervisorController.js
│     ├─ models/
│     │  ├─ HelpRequest.js
│     │  ├─ KnowledgeBase.js
│     │  └─ Supervisor.js
│     ├─ routes/
│     │  ├─ helpRequests.js
│     │  ├─ knowledgeBase.js
│     │  ├─ supervisors.js
│     │  └─ webhook.js
│     ├─ services/
│     │  ├─ aiAgent.js
│     │  ├─ escalation.js
│     │  ├─ livekitAgent.js
│     │  ├─ openaiService.js
│     │  ├─ textToSpeech.js
│     │  └─ timeoutHandler.js
│     └─ utils/{errorHandler.js, logger.js}
├─ frontend/
│  ├─ package.json
│  ├─ vite.config.js
│  └─ src/
│     ├─ App.jsx, main.jsx, index.css
│     ├─ components/{Navbar.jsx, RequestList.jsx, KnowledgeBaseList.jsx}
│     ├─ pages/{Login.jsx, PendingRequests.jsx, ResolvedRequests.jsx, KnowledgeBase.jsx, TestAI.jsx, LiveVoice.jsx}
│     └─ services/api.js
└─ docs & root configs (README.md, DEPLOYMENT.md, vite/ts/tailwind configs)
```

## REST API

Base URL: https://human-in-the-loop-ai-supervisor-0umh.onrender.com/api

Help Requests

| Method | Path                                   | Description                                   |
|--------|----------------------------------------|-----------------------------------------------|
| GET    | /help-requests                         | List all help requests                        |
| GET    | /help-requests/pending                 | List pending requests                          |
| GET    | /help-requests/resolved                | List resolved requests                         |
| GET    | /help-requests/unresolved              | List unresolved (timed out)                    |
| GET    | /help-requests/:id                     | Get one                                       |
| POST   | /help-requests                         | Create { customerName, question }             |
| POST   | /help-requests/:id/resolve            | Resolve { answer }                            |
| DELETE | /help-requests/:id                     | Delete                                         |
| POST   | /help-requests/simulate-livekit-call   | Simulate agent via LiveKit adapter            |

Knowledge Base

| Method | Path                         | Description                              |
|--------|------------------------------|------------------------------------------|
| GET    | /knowledge-base              | List entries                             |
| GET    | /knowledge-base/search?q=.. | Search                                    |
| GET    | /knowledge-base/:id         | Get one                                  |
| POST   | /knowledge-base             | Create { question, answer, tags? }       |
| PUT    | /knowledge-base/:id         | Update                                    |
| DELETE | /knowledge-base/:id         | Delete                                    |
| POST   | /knowledge-base/supervisor-answer | Save approved answer back to KB    |

Supervisors

| Method | Path            | Description                        |
|--------|-----------------|------------------------------------|
| POST   | /supervisors/register | Register                       |
| POST   | /supervisors/login    | Login (JWT)                   |
| GET    | /supervisors          | List supervisors              |
| GET    | /supervisors/:id      | Get one                       |

Agent & Voice

| Method | Path                 | Description                                                      |
|--------|----------------------|------------------------------------------------------------------|
| POST   | /simulate-call       | Text agent: { customerName, question } → { response }           |
| GET    | /voice/tts?text=..   | TTS test → audio (Content-Type audio/mpeg by default)           |
| POST   | /voice/reply         | Text in → text+audio out; { customerName, question, voice? }    |
| POST   | /voice/stt-respond   | Multipart: audio (webm/opus). Optional field: voice             |
| POST   | /livekit/token       | Issue LiveKit access token (body: { identity, roomName })       |
| GET    | /livekit/token       | Token (query: identity, roomName) for quick checks              |
| POST   | /livekit/simulate-call | Simulate via LiveKit service path                             |

Health

| Method | Path     | Description           |
|--------|----------|-----------------------|
| GET    | /health  | Server liveness check |

## Environment variables

Backend (.env)

```env
PORT=5000
NODE_ENV=production
MONGO_URI=mongodb://localhost:27017/human-in-loop-ai
ALLOW_NO_DB=1
JWT_SECRET=change-me

# OpenAI
OPENAI_API_KEY=your-openai-key
TTS_VOICE=verse # alloy/verse supported

# LiveKit
LIVEKIT_URL=wss://your-livekit.livekit.cloud
LIVEKIT_API_KEY=lk_api_key
LIVEKIT_API_SECRET=lk_api_secret

# CORS (comma-separated; supports wildcards like https://*.vercel.app)
CORS_ORIGIN=https://reception-ai-inky.vercel.app
```

Frontend (.env.local)

```env
# Prefer the deployed backend API URL
VITE_API_BASE_URL=https://human-in-the-loop-ai-supervisor-0umh.onrender.com/api
# LiveKit URL for client join
VITE_LIVEKIT_URL=wss://your-livekit.livekit.cloud
```

## Local development

Backend

```powershell
cd backend
npm install
copy .env.example .env
# Edit .env → set MONGO_URI, OPENAI_API_KEY, CORS_ORIGIN (include http://localhost:5173 for Vite dev)
npm start
```

Frontend

```powershell
cd frontend
npm install
"VITE_API_BASE_URL=http://localhost:5000/api" | Out-File -Encoding ascii .env.local
# Optionally set VITE_LIVEKIT_URL to use LiveKit from dev
npm run dev
```

## Quick tests (PowerShell)

```powershell
# Health
Invoke-RestMethod 'http://localhost:5000/api/health'

# Text agent
$body = @{ customerName = 'Alice'; question = 'What are your hours?' } | ConvertTo-Json
Invoke-RestMethod 'http://localhost:5000/api/simulate-call' -Method Post -Body $body -ContentType 'application/json'

# TTS test (server)
curl "http://localhost:5000/api/voice/tts?text=Hello%20there" -o tts.mp3

# LiveKit token (GET)
Invoke-RestMethod 'http://localhost:5000/api/livekit/token?identity=tester&roomName=salon-room'
```

## Voice handling

- Server speech path: STT (OpenAI) → agent → TTS (OpenAI). Endpoint: `/api/voice/stt-respond` (multipart: `audio` field; optional `voice`).
- Text path: `/api/voice/reply` synthesizes audio for the returned answer.
- Browser fallback: LiveVoice page uses `SpeechRecognition` + `speechSynthesis` when server speech is unavailable/rate-limited.
- LiveKit: Backend issues tokens via `/api/livekit/token`; client connects using `VITE_LIVEKIT_URL`.

## Deployment (Render + Vercel)

Backend (Render)
- Create a Web Service pointing to `backend` folder; auto start command from package.json.
- Set env vars (see above). Health check: `/api/health`.
- Set `CORS_ORIGIN` to your Vercel domains (supports comma list and wildcards like `https://*.vercel.app`).

Frontend (Vercel)
- Project root: `frontend`. Set `VITE_API_BASE_URL` to your Render API (e.g., `https://<render>.onrender.com/api`).
- Optionally, include `frontend/vercel.json` with rewrites to proxy relative routes to Render.
- Set `VITE_LIVEKIT_URL` if using LiveKit.

## Troubleshooting

- 404 from API on Vercel: ensure `VITE_API_BASE_URL` is set or rewrites in `frontend/vercel.json` map API paths to the Render domain.
- CORS errors: update backend `CORS_ORIGIN` to include the exact Vercel URL(s) or use wildcard patterns.
- Port conflicts locally: stop other services on 5000 or point `VITE_API_BASE_URL` to the deployed backend.
- Beep-only or frequent fallback: verify OpenAI key quota; the browser fallback continues to work without keys.
- LiveKit token errors: set `LIVEKIT_API_KEY/SECRET` on the backend and `VITE_LIVEKIT_URL` on the frontend.

## Security

- Do not commit API keys. Prefer environment variables and per-environment secrets.
- Restrict `CORS_ORIGIN` in production to your domains only.
- JWT secrets should be long and rotated. Never expose LiveKit API secret to the client.

## License

MIT

## Contact

Author: Jitendra Dodwadiya  
LinkedIn: https://www.linkedin.com/in/dwdjitendra/  
Portfolio: https://dwdjitendra-portfolio.vercel.app/

# Human-in-the-Loop AI Supervisor

Full-stack supervisor workflow for handling customer questions with a learning loop. The automated agent answers from a knowledge base and defaults; unknown questions are escalated to supervisors who resolve and optionally save answers back to the knowledge base.

- Backend: Node.js / Express / MongoDB (Mongoose)
- Frontend: React (Vite) + Tailwind CSS
- Voice: optional server STT/Chat/TTS; browser STT/TTS fallback; LiveKit token endpoint

Live deployments
- Backend (Render): https://human-in-the-loop-ai-supervisor-0umh.onrender.com
- Frontend (Vercel): https://reception-ai-inky.vercel.app

## Features
- Help request lifecycle: Pending, Resolved, Unresolved (timeout)
- Supervisor dashboard and Knowledge Base management
- Automated agent: KB lookup → defaults → escalation
- Voice endpoints: text-to-speech, STT→reply→TTS, token route for LiveKit
- Browser fallback for speech (no server key required)
- Basic webhook support for notifications

## Architecture
1. Frontend sends question.
2. Backend agent
   - tries KB
   - falls back to defaults (hours, address, services, phone)
   - escalates if unknown
3. Supervisors resolve, optionally save answer to KB.
4. Agent follows up using saved answer.

MongoDB stores help requests, KB entries, and supervisors. The frontend consumes a REST API.

## Project Structure
```
Human-in-the-Loop AI Supervisor/
├─ backend/
│  └─ src/{config,controllers,models,routes,services,utils}
└─ frontend/
   └─ src/{components,pages,services}
```

## API (base: /api)

Help Requests
- GET /help-requests
- GET /help-requests/pending
- GET /help-requests/resolved
- GET /help-requests/unresolved
- GET /help-requests/:id
- POST /help-requests
- POST /help-requests/:id/resolve
- DELETE /help-requests/:id

Knowledge Base
- GET /knowledge-base
- GET /knowledge-base/:id
- POST /knowledge-base
- PUT /knowledge-base/:id
- DELETE /knowledge-base/:id
- GET /knowledge-base/search?q=...

Agent
- POST /simulate-call
- POST /help-requests/simulate-livekit-call

Voice
- GET /voice/tts?text=Hello
- POST /voice/reply { customerName, question }
- POST /voice/stt-respond (multipart: audio=Blob, optional voice)
- POST /livekit/token { identity, roomName }

Health
- GET /health

## Environment Variables

Backend (.env)
```
PORT=5000
NODE_ENV=development
MONGO_URI=mongodb://localhost:27017/human-in-loop-ai
ALLOW_NO_DB=1
JWT_SECRET=change-me

OPENAI_API_KEY=
TTS_VOICE=alloy

LIVEKIT_URL=
LIVEKIT_API_KEY=
LIVEKIT_API_SECRET=

# CORS: comma-separated or wildcard patterns (e.g., https://*.vercel.app)
CORS_ORIGIN=
```

Frontend (.env.local)
```
VITE_API_BASE_URL=http://localhost:5000/api
VITE_LIVEKIT_URL=
```

## Local Development
Backend
```
cd backend
npm install
cp .env.example .env  # set values
npm start
```
Frontend
```
cd frontend
npm install
echo VITE_API_BASE_URL=http://localhost:5000/api > .env.local
npm run dev
```

PowerShell quick checks
```
Invoke-RestMethod -Uri 'http://localhost:5000/api/health' -Method Get | ConvertTo-Json -Depth 5
Invoke-RestMethod -Uri 'http://localhost:5000/api/simulate-call' -Method Post -Body (@{customerName='Alice'; question='Hours?'} | ConvertTo-Json) -ContentType 'application/json' | ConvertTo-Json -Depth 5
```

## Voice
- Server TTS: /voice/tts and /voice/reply
- Full loop: /voice/stt-respond (STT → agent/chat → TTS)
- Browser fallback: SpeechRecognition + speechSynthesis in LiveVoice page
- LiveKit: token route, client joins via VITE_LIVEKIT_URL

## Deployment
- Backend: Render (Web Service). Set envs; health at /api/health.
- Frontend: Vercel (Vite). Set VITE_API_BASE_URL to the backend /api URL.
- Optional: vercel.json rewrites in frontend to proxy /api calls to Render.
See DEPLOYMENT.md for full details.

## Troubleshooting
- 404 from /help-requests on Vercel: set VITE_API_BASE_URL or ensure vercel.json rewrites are active and the project root is frontend.
- CORS errors: set CORS_ORIGIN on backend (supports comma list and wildcards).
- Beep-only voice: missing/limited OpenAI key; browser fallback continues working.
- Port conflicts locally: free port 5000 or set VITE_API_BASE_URL to deployed backend.

## Security
- Do not commit secrets. Rotate keys if exposed.
- Restrict CORS_ORIGIN to your domains in production.

## License
MIT

## Contact
Author: Jitendra Dodwadiya  
LinkedIn: https://www.linkedin.com/in/dwdjitendra/  
Portfolio: https://dwdjitendra-portfolio.vercel.app/


